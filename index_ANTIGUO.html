<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monitor ONTs - OLT Huawei</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v={{ config['APP_VERSION'] }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-network-wired text-primary"></i>
                    Monitor ONTs - OLT HUAWEI MA5800-X15
                </h1>
                <!-- Agregar esta sección después del h1 en index.html, antes del formulario -->

                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body text-center">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('ont.index') }}" class="btn btn-primary">
                                        <i class="fas fa-list"></i> Monitor Individual ONTs
                                    </a>
                                    <a href="{{ url_for('ont.monitor') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-th-large"></i> Monitor General Puertos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Formulario de consulta -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-search"></i> Consultar ONTs</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="consultaForm" class="row g-3">
                            <div class="col-md-4">
                                <label for="tarjeta" class="form-label">
                                    <i class="fas fa-microchip"></i> Tarjeta
                                </label>
                                <input type="text" class="form-control" id="tarjeta" name="tarjeta" 
                                       placeholder="Ej: 4" value="{{ tarjeta }}" required>
                            </div>
                            <div class="col-md-4">
                                <label for="puerto" class="form-label">
                                    <i class="fas fa-plug"></i> Puerto
                                </label>
                                <input type="text" class="form-control" id="puerto" name="puerto" 
                                       placeholder="Ej: 0" value="{{ puerto }}" required>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Consultar ONTs
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Mensajes flash -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% elif category == 'warning' %}warning{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {% if category == 'error' %}
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% elif category == 'success' %}
                                    <i class="fas fa-check-circle"></i>
                                {% elif category == 'warning' %}
                                    <i class="fas fa-exclamation-circle"></i>
                                {% endif %}
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Resumen de resultados -->
                {% if onts %}
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">
                                    <i class="fas fa-list"></i> Total ONTs
                                </h5>
                                <h3 class="text-primary">{{ summary.total_onts }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success">
                                    <i class="fas fa-check-circle"></i> Online
                                </h5>
                                <h3 class="text-success">{{ summary.online_onts }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <h5 class="card-title text-danger">
                                    <i class="fas fa-times-circle"></i> Offline
                                </h5>
                                <h3 class="text-danger">{{ summary.total_onts - summary.online_onts }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">
                                    <i class="fas fa-exclamation-triangle"></i> RX Crítico
                                </h5>
                                <h3 class="text-warning">{{ summary.critical_onts }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón de exportar -->
                <div class="d-flex justify-content-end mb-3">
                    <a href="{{ url_for('ont.download_excel') }}" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </a>
                </div>

                <!-- Tabla de resultados -->
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table"></i> 
                            Resultados - Tarjeta {{ tarjeta }} Puerto {{ puerto }}
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th><i class="fas fa-hashtag"></i> ID</th>
                                        <th><i class="fas fa-tag"></i> Descripción</th>
                                        <th><i class="fas fa-signal"></i> ONT RX</th>
                                        <th><i class="fas fa-broadcast-tower"></i> OLT RX</th>
                                        <th><i class="fas fa-chart-line"></i> Diferencia</th>
                                        <th><i class="fas fa-thermometer-half"></i> Temp</th>
                                        <th><i class="fas fa-ruler"></i> Distancia</th>
                                        <th><i class="fas fa-circle"></i> Estado</th>
                                        <th><i class="fas fa-info-circle"></i> Última Caída</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ont in onts %}
                                    <tr>
                                        <td>{{ ont.id }}</td>
                                        <td>{{ ont.descripcion or '-' }}</td>
                                        <td>{{ ont.ont_rx if ont.ont_rx is not none else '-' }}</td>
                                        <td>{{ ont.olt_rx if ont.olt_rx is not none else '-' }}</td>
                                        <td class="{{ 'rx-critical' if ont.has_critical_rx_diff else '' }}">
                                            {{ ont.rx_diff if ont.rx_diff is not none else '-' }}
                                        </td>
                                        <td>{{ ont.temperature if ont.temperature is not none else '-' }}</td>
                                        <td>{{ ont.distance if ont.distance is not none else '-' }} m</td>
                                        <td>
                                            {% if ont.is_online %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-circle"></i> Online
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-circle"></i> Offline
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>{{ ont.last_down_cause or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No hay resultados</h4>
                    <p class="text-muted">Ingrese los parámetros y haga clic en "Consultar ONTs"</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h4 class="mt-3 text-primary">Consultando dispositivo...</h4>
        <p class="text-muted">Por favor espere, esto puede tomar unos momentos</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("consultaForm");
            const loadingOverlay = document.getElementById("loadingOverlay");

            form.addEventListener("submit", function(e) {
                // Validar campos
                const tarjeta = document.getElementById("tarjeta").value.trim();
                const puerto = document.getElementById("puerto").value.trim();
                
                if (!tarjeta || !puerto) {
                    e.preventDefault();
                    alert("Por favor complete todos los campos");
                    return;
                }
                
                // Mostrar loading
                loadingOverlay.style.display = "flex";
                
                // Deshabilitar botón para evitar doble submit
                const submitBtn = form.querySelector("button[type='submit']");
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando...';
            });

            // Auto-ocultar alerts después de 5 segundos
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });
    </script>
    <footer class="text-center py-3 bg-light border-top">
        <small class="text-muted">
            Monitor ONTs - OLT Huawei | Versión {{ config['APP_VERSION'] }}
        </small>
    </footer>
</body>
</html>
